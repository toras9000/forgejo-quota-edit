#!/usr/bin/env -S dotnet run --file
#:package ForgejoApiClient@13.0.0-rev.2
#:package Kokuban@0.2.0
#:package Lestaly.General@0.114.0
#:package RefFile@0.2.0
#:property PublishAot=false
using ForgejoApiClient;
using ForgejoApiClient.Api;
using Kokuban;
using Lestaly;
[assembly: RefFile("../.env-helper.cs1")]

var settings = new
{
    // サービスのURL
    ServiceURL = new Uri("http://localhost:9950"),

    // トークン保存ファイル
    ApiKeyFile = ThisSource.RelativeFile("../.auth-forgejo-api"),

    // 作成するQuota Ruleの定義
    QuotaRules = new CreateQuotaRuleOptions[]
    {
        new(name: "default-rule", limit: 500 * 1024 * 1024, subjects: ["size:all"]),
        new(name: "packages-narrow", limit: 100 * 1024 * 1024, subjects: ["size:assets:packages:all"]),
    },

    // 作成するQuota Groupの定義
    QuotaGroups = new CreateQuotaGroupOptions[]
    {
        new(name: "default-group", rules:[new(name: "default-rule")]),
        new(name: "packages-limited", rules:[new(name: "packages-narrow")]),
    },

    // 作成するQuota Groupの定義
    UserAssigns = new[]
    {
        new { Group = "packages-limited", User = "test-user", },
    },
};

return await Paved.ProceedAsync(noPause: args.RoughContains("--no-interact"), async () =>
{
    using var signal = new SignalCancellationPeriod();

    Console.WriteLine("APIトークンを読み込み ...");
    var forgejoToken = await settings.ApiKeyFile.ScriptScrambler().LoadTokenAsync(signal.Token) ?? throw new Exception("トークン情報を読み取れない");
    if (forgejoToken.Service.AbsoluteUri != settings.ServiceURL.AbsoluteUri) throw new Exception("保存情報が対象と合わない");

    Console.WriteLine("クライアント準備 ...");
    using var forgejo = new ForgejoClient(forgejoToken.Service, forgejoToken.Token);
    using (var breaker = CancellationTokenSource.CreateLinkedTokenSource(signal.Token))
    {
        // 初期化直後はAPI呼び出しがエラーとなることがあるようなので、一定時間繰り返し呼び出しを試みる。
        breaker.CancelAfter(TimeSpan.FromSeconds(5));
        while (true)
        {
            try { if (await forgejo.User.GetMeAsync(breaker.Token) is { login: not null }) break; } catch { await Task.Delay(500, breaker.Token); }
        }
    }

    Console.WriteLine("クォータルールの作成 ...");
    var rules = (await forgejo.Admin.ListQuotaRulesAsync(signal.Token)).ToList();
    foreach (var options in settings.QuotaRules)
    {
        Console.WriteLine($"  QuotaRule: {Chalk.Blue[options.name!]}");
        Console.Write("  .. ");
        if (rules.Any(g => g.name == options.name))
        {
            Console.WriteLine(Chalk.Gray["既に存在する"]);
            continue;
        }

        try
        {
            var rule = await forgejo.Admin.CreateQuotaRuleAsync(options, signal.Token);
            rules.Add(rule);
            Console.WriteLine(Chalk.Green["作成"]);
        }
        catch (Exception ex)
        {
            Console.WriteLine(Chalk.Red[ex.Message]);
        }
    }

    Console.WriteLine("クォータグループの作成 ...");
    var groups = (await forgejo.Admin.ListQuotaGroupsAsync(signal.Token)).ToList();
    foreach (var options in settings.QuotaGroups)
    {
        Console.WriteLine($"  QuotaGroup: {Chalk.Blue[options.name!]}");
        Console.Write("  .. ");
        if (groups.Any(g => g.name == options.name))
        {
            Console.WriteLine(Chalk.Gray["既に存在する"]);
            continue;
        }

        try
        {
            var group = await forgejo.Admin.CreateQuotaGroupAsync(options, signal.Token);
            groups.Add(group);
            Console.WriteLine(Chalk.Green["作成"]);
        }
        catch (Exception ex)
        {
            Console.WriteLine(Chalk.Red[ex.Message]);
        }
    }

    Console.WriteLine("クォータグループの割当 ...");
    foreach (var assign in settings.UserAssigns)
    {
        Console.WriteLine($"  Assign: {Chalk.Blue[assign.Group]} to {Chalk.Blue[assign.User]}");
        Console.Write("  .. ");
        try
        {
            await forgejo.Admin.AddQuotaGroupUserAsync(assign.Group, assign.User, signal.Token);
            Console.WriteLine(Chalk.Green["割当"]);
        }
        catch (Exception ex)
        {
            Console.WriteLine(Chalk.Red[ex.Message]);
        }
    }

});
