#!/usr/bin/env -S dotnet run --file
#:package ForgejoApiClient@13.0.0-rev.2
#:package Kokuban@0.2.0
#:package Lestaly.General@0.114.0
#:package RefFile@0.2.0
#:property PublishAot=false
using ForgejoApiClient;
using ForgejoApiClient.Api;
using Kokuban;
using Lestaly;
[assembly: RefFile("../.env-helper.cs1")]

var settings = new
{
    // サービスのURL
    ServiceURL = new Uri("http://localhost:9950"),

    // トークン保存ファイル
    AdminApiKeyFile = ThisSource.RelativeFile("../.auth-forgejo-api"),

    // 作成するユーザの定義
    Users = new CreateUserOption[]
    {
        new(username: "test-user", email: "test@example.com", password: "test-pass", full_name: "テストユーザ", must_change_password: false),
        new(username: "toras9000", email: "toras9000@example.com", password: "toras9000-pass", full_name: "toras9000", must_change_password: false),
    },

    // 作成する組織の定義
    Organizations = new CreateOrgOption[]
    {
        new(username: "test-org", full_name: "テスト組織"),
        new(username: "oss", full_name: "OSS"),
    },

    // 作成するチームの定義
    Teams = new TeamDefine[]
    {
        new("test-org", new(name: "test-team1", units_map: new Dictionary<string, string>()
        {
            ["repo.code"] = "write",
            ["repo.ext_issues"] = "write",
            ["repo.ext_wiki"] = "write",
            ["repo.issues"] = "write",
            ["repo.projects"] = "write",
            ["repo.pulls"] = "write",
            ["repo.releases"] = "write",
            ["repo.wiki"] = "write",
        })),
    },
};

return await Paved.ProceedAsync(noPause: args.RoughContains("--no-interact"), async () =>
{
    using var signal = new SignalCancellationPeriod();

    Console.WriteLine("APIトークンを読み込み ...");
    var forgejoToken = await settings.AdminApiKeyFile.ScriptScrambler().LoadTokenAsync(signal.Token) ?? throw new Exception("トークン情報を読み取れない");
    if (forgejoToken.Service.AbsoluteUri != settings.ServiceURL.AbsoluteUri) throw new Exception("保存情報が対象と合わない");

    Console.WriteLine("クライアント準備 ...");
    using var forgejo = new ForgejoClient(forgejoToken.Service, forgejoToken.Token);
    var me = default(User);
    using (var breaker = signal.Token.CreateLink(TimeSpan.FromSeconds(5)))
    {
        // 初期化直後はAPI呼び出しがエラーとなることがあるようなので、一定時間繰り返し呼び出しを試みる。
        while (me?.login == null)
        {
            try { me = await forgejo.User.GetMeAsync(breaker.Token); }
            catch { await Task.Delay(TimeSpan.FromMilliseconds(500), breaker.Token); }
        }
    }

    Console.WriteLine("ユーザの作成 ...");
    foreach (var options in settings.Users)
    {
        Console.WriteLine($"  CreateUser: {Chalk.Blue[options.username]}");
        Console.Write("  .. ");
        try
        {
            var user = await forgejo.Admin.CreateUserAsync(options, signal.Token);
            Console.WriteLine(Chalk.Green["作成"]);
        }
        catch (Exception ex)
        {
            Console.WriteLine(Chalk.Red[ex.Message]);
        }
    }

    Console.WriteLine("組織の作成 ...");
    foreach (var options in settings.Organizations)
    {
        Console.WriteLine($"  CreateOrg: {Chalk.Blue[options.username]}");
        Console.Write("  .. ");
        try
        {
            var user = await forgejo.Admin.CreateOrganizationAsync(me.login, options, signal.Token);
            Console.WriteLine(Chalk.Green["作成"]);
        }
        catch (Exception ex)
        {
            Console.WriteLine(Chalk.Red[ex.Message]);
        }
    }

    Console.WriteLine("チームの作成 ...");
    foreach (var define in settings.Teams)
    {
        Console.WriteLine($"  CreateTeam: {Chalk.Blue[define.Org]} - {Chalk.Blue[define.Options.name]}");
        Console.Write("  .. ");
        try
        {
            var user = await forgejo.Organization.CreateTeamAsync(define.Org, define.Options, signal.Token);
            Console.WriteLine(Chalk.Green["作成"]);
        }
        catch (Exception ex)
        {
            Console.WriteLine(Chalk.Red[ex.Message]);
        }
    }
});

record TeamDefine(string Org, CreateTeamOption Options);
