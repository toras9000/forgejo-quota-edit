#!/usr/bin/env -S dotnet run --file
#:package AngleSharp@1.4.0
#:package Lestaly.General@0.114.0
using System.Net;
using AngleSharp;
using AngleSharp.Dom;
using AngleSharp.Html.Dom;
using AngleSharp.Io;
using Lestaly;

var settings = new
{
    // サービスのURL
    ServiceURL = "http://localhost:9950",

    // 初回起動セットアップの設定
    Setup = new
    {
        // セットアップ時の admin ユーザ名
        AdminUser = "forgejo-admin",
        // セットアップ時の admin パスワード
        AdminPass = "forgejo-admin-pass",
        // セットアップ時の admin メールアドレス
        AdminMail = "forgejo-admin@example.com",
    },
};

return await Paved.ProceedAsync(noPause: args.RoughContains("--no-interact"), async () =>
{
    using var signal = new SignalCancellationPeriod();

    // サービスリンクを表示
    Console.WriteLine();
    Console.WriteLine("Service URL");
    Console.WriteLine($"  {Poster.Link[settings.ServiceURL]}");
    Console.WriteLine();

    // 初回起動(セットアップフォームが表示されるか)を判別する
    Console.WriteLine("初期化状態の取得中 ...");
    var requester = new DefaultHttpRequester();
    requester.Timeout = TimeSpan.FromSeconds(3 * 60);
    var config = Configuration.Default.With(requester).WithDefaultLoader();
    using var context = BrowsingContext.New(config);

    // ページ取得。なぜか空の内容が得られる場合があるので、空の場合はリトライする
    var setupPage = default(IDocument);
    using (var timeout = signal.Token.CreateLink(TimeSpan.FromSeconds(30)))
    {
        while (setupPage == null)
        {
            var document = await context.OpenAsync(settings.ServiceURL, timeout.Token);
            if (document != null && document.StatusCode == HttpStatusCode.OK && 0 < document.Source.Length)
            {
                setupPage = document;
                break;
            }
            document?.Dispose();
            await Task.Delay(TimeSpan.FromMilliseconds(500));
        }
    }
    using (setupPage)
    {
        // 未初期化時に存在する要素の取得を試みる
        var container = setupPage.QuerySelector<IHtmlDivElement>(".install-config-container");
        if (container == null)
        {
            // 初回起動画面を検出できない場合はすでにセットアップ済みと思われるので処理を終える
            Console.WriteLine(".. 既にインスタンスが初期化されている");
            return;
        }

        // 初回起動らしきページを得た場合はセットアップ処理継続
        Console.WriteLine(".. 初期セットアップが必要であることを検出");

        // セットアップフォームの取得を試みる
        Console.WriteLine("初期セットアップを実施中 ...");
        var forms = container.Descendants<IHtmlFormElement>().ToArray();
        if (forms.Length != 1) throw new PavedMessageException("ページ構造が想定外");
        var setupForm = forms[0];
        var inputUpdateChecker = setupForm.QuerySelectorAll<IHtmlInputElement>("*").FirstOrDefault(e => e.Type == "checkbox" && e.Name == "enable_update_checker");
        if (inputUpdateChecker == null) throw new PavedMessageException("Unexpected setup form");
        inputUpdateChecker.IsChecked = false;

        // セットアップパラメータを指定して送信
        using var setupResult = await setupForm.SubmitAsync(new
        {
            admin_name = settings.Setup.AdminUser,
            admin_email = settings.Setup.AdminMail,
            admin_passwd = settings.Setup.AdminPass,
            admin_confirm_passwd = settings.Setup.AdminPass,
        });
        var loadingElement = setupResult.GetElementById("goto-user-login");
        if (loadingElement == null) throw new PavedMessageException("ページ構造が想定外");
    }

    // セットアップ完了を待つ
    Console.WriteLine("セットアップの完了を待機 ...");
    using (var timeout = signal.Token.CreateLink(TimeSpan.FromSeconds(30)))
    {
        while (true)
        {
            await Task.Delay(TimeSpan.FromSeconds(1));
            using var document = await context.OpenAsync(settings.ServiceURL, timeout.Token);
            if (document == null || document.StatusCode != HttpStatusCode.OK || document.Source.Length <= 0) continue;
            var loading = document.GetElementById("goto-user-login");
            if (loading == null) break; // loading finish
        }
    }
    Console.WriteLine(".. セットアップ完了");
});
